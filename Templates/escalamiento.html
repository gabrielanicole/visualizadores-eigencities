<!DOCTYPE html>
{% load static %}

<html>
<head>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script> -->

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>


 <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script src="https://d3js.org/d3.v3.min.js"></script>
  <link rel="stylesheet" href="{% static 'css/escalamiento_style.css' %}">
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  
</head>


<body>


<div class = "container" >
	<div class = "row" id= "titulo">
		<h1> Observatorio de escalamiento</h1>
	</div>
	<div class ="row" >
		<div class = "col-md-6">
		<select id = "SelectVar"  class="selectpicker show-tick "  title="Variable de escalamiento" > 
	  		<option value= "vehicle"> vehiculos </option>
	  		<option value= "motor"> vehiculos motorizados </option>
	  		<option value= "Non_motorized"> vehiculos no motorizados </option>
	  		<!-- <option value= "private_transport"> Transporte privado </option> -->
	  		<option value= "public_transport"> Transporte público </option>
	  		<!-- <option value= "CO2_transport"> CO2 (fuentes moviles) </option> -->
	  		<option value= "Green"> Espacios verdes </option>
	  		<option value= "Iliteracy"> Analfabetismo </option>
		</select>
		</div>
	</div>

	<div class ="row" id = "graficos" >
		<div class = "col-md-6" id = "escalamiento" > </div>
		<div class = "col-md-3" id = "pais" > </div>
		<div class = "col-md-3" id = "desviaciones" > </div>
	</div>
</body>


<script type="text/javascript"> 
	console.log("hola "); 
	x = [];
	y = [];
$( "#SelectVar" ).change(function() {
  console.log("SelectVar.val: ", $('#SelectVar').val() );
  var varSelect = $('#SelectVar').val() ;
  //var log = "log_".concat(varSelect);
  //console.log(log);
  var valor = 0.0 ; 
	 
 //  	{% for ciudad in ciudades %}
	// 	console.log("{{ciudad.nombre}} ");
 //  		valor = {{ciudad.varSelect}};
	// 	console.log(valor);
	// {% endfor %}
	var variables = 0;
	//Para el mapa pido los datos de log_variable 
	$.ajax({
		url: "{% url 'escalamiento' %}" , 
		type: 'POST',
		async: false,
		data: {
			varSelect : varSelect,
			csrfmiddlewaretoken: '{{ csrf_token }}'} ,
		success: function(data) {
			console.log("llego");
			console.log(data['results']);

			//array1.forEach(function(element) {
			//	console.log(element);
			//	});
			variables = data['results'];
			
			
			scaling_graph(variables, $('#SelectVar  option:selected').text(), data['reg']);
		/*	variables.forEach(function(c){
				x.push(c);
				y.push();

			})*/


		},
		failure: function(data) {
			alert('Error de conexión');
		},
		crossDomain: true
	});
	console.log(variables);
	console.log("fin ajax");


});



function scaling_graph(dataset, varS, reg) {
	//var xAxis = d3.svg.axis(); 
	var w = 600;
	var h = 300; 
	var padding = 30;
	var svg = d3.select("#escalamiento")
            .append("svg")
			.attr("class", "graph_escalamiento")
            .attr("width", w)
            .attr("height", h);

	

	var scale = d3.scale.linear();

   var xScale = d3.scale.linear()
                     .domain([0, d3.max(dataset, function(d) { return d[1]*1.2; })])
                     .range([padding, w - padding * 2]);

	var yScale = d3.scale.linear()
                     .domain([0 , d3.max(dataset, function(d) { return d[2]*1.2; })])
                     .range([h - padding, padding]);

var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return "<strong> <center>"+ d[0] + "</center> </strong>  </br> Población:  <span style='color:red'>  " + Number(d[3]).toFixed(0) +
	 "</span> </br><strong>"+ varS +"</strong> <span style='color:red'> "+ Number(d[4]).toFixed(2)+ "</span> " +
	"</br><strong> Estimado </strong> <span style='color:red'> "+ Number(Math.exp(reg[1] + (reg[0]*d[1]) ) ).toFixed(2)+ "</span> ";
  })


	svg.selectAll("circle")
		.data(dataset)
		.enter()
		.append("circle")
		.attr("cx", function(d) {
				return xScale(d[1]);
		})
		.attr("cy", function(d) {
				return yScale(d[2]); //h - d[2]*10;
		})
		.attr("r",  function(d) {
				return d[2]*0.7;
		})
		.attr("fill", function(d) {return color(d,reg); } )
		.attr("fill-opacity", 0.6)
		.on('mouseover', tip.show)
		.on('mouseout', tip.hide);
	svg.call(tip);


	// apply the reults of the least squares regression
	var x1 = d3.min(dataset, function(d) { return Number(d[1])*0.8; }) ;
	var y1 = reg[1] + reg[0]*x1 ;
	var x2 = d3.max(dataset, function(d) { return Number(d[1])*1.2; }) ;
	var y2 = reg[1] + reg[0]*x2;
	var trendData = [[x1,y1,x2,y2]];
	console.log("trenddata:", trendData);
	//var trendline = svg.selectAll(".trendline")
	//	.data(trendData);
	
	svg.selectAll("line")
		.data(trendData)
		.enter()
		.append("line")
		.attr("class", "trendline")
		.attr("x1", function(d) { return xScale(d[0]); })
		.attr("y1", function(d) { return yScale(d[1]); })
		.attr("x2", function(d) { return xScale(d[2]); })
		.attr("y2", function(d) { return yScale(d[3]); })
		.attr("stroke", "rgba(146, 146, 146, 0.8)")
		.attr("stroke-width",3);
	

	svg.append("text")
		.text("eq: " + Number(reg[1]).toFixed(2)   + " + " + Number(reg[0]).toFixed(2) + "x"  )
		.attr("class", "text-label")
		.attr("y", h - (padding*2))
		.attr("x", w )
		.style("text-anchor", "end");

// 	svg.selectAll("text")
// 		.data(dataset)
// 		.enter()
// 		.append("text")
// 		.text(function(d) {
//         return d[0] ;
//    })
// 		.attr("x", function(d) {
// 				return xScale(d[1]); //return  d[1]*20;
// 		})
// 		.attr("y", function(d) {
// 				return yScale(d[2]); //return h - d[2]*20;
// 		})
// 		.attr("font-family", "sans-serif")
// 		.attr("font-size", "11px")
// 		.attr("fill", "red");


	var xAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient("bottom").ticks(10); 

	svg.append("g")
    .attr("class", "axis")  //Assign "axis" class
	.attr("transform", "translate(0," + (h - padding) + ")")
	.call(xAxis)
	.append("text")
      .attr("y", (-1*padding)*0.5 )
	  .attr("x", w )
      .attr("dy", ".71em")
      .style("text-anchor", "end")
	  .text("[Log] Número de habitantes");

	
	
	var yAxis = d3.svg.axis()
                  .scale(yScale)
                  .orient("left")
                  .ticks(10);

	svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(" + padding + ",0)")
    .call(yAxis)
	.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
	  .text("[Log] " + varS);
	
}

function color(d, reg){
	var estimado = reg[1] + reg[0]*d[1];
	if (d[2] > estimado) return "#800000" //rojo
	else  return "#000080"; //azul

}

	// $('#SelectVar').on('hidden.bs.select', function (e) {
	// 	console.log("en selectvar");
	// 	console.log(e);
	// 	// console.log("SelectVar.val: ", $('#SelectVar').val() );
	// 	// varSelect != $('#SelectVar').val() ? console.log("no seleccionado") : null;
	// 	// varSelect = $('#SelectVar').val();
	// 	// console.log("SelectVar: ", varSelect);

 //        //$('select option[value="'+valores_seleccionados[i]+'"]').attr('descripcion')) ;
 //  		//Cargar todas las torres. 
 //  		//(analisis != null & idCiudad != null & idindicadores != null ) ? doAnalisis() : null;
		
	// });	



</script> 




</html>

